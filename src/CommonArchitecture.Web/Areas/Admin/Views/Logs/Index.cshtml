@{
    ViewData["Title"] = "System Logs";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid px-4">
    <h1 class="mt-4">System Logs</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/Admin/Dashboard">Dashboard</a></li>
        <li class="breadcrumb-item active">System Logs</li>
    </ol>

    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-filter me-1"></i>
            Filter Logs
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search logs...">
                </div>
                <div class="col-md-2">
                    <select id="methodFilter" class="form-select">
                        <option value="">All Methods</option>
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="statusCodeFilter" class="form-select">
                        <option value="">All Statuses</option>
                        <option value="200">200 OK</option>
                        <option value="400">400 Bad Request</option>
                        <option value="401">401 Unauthorized</option>
                        <option value="403">403 Forbidden</option>
                        <option value="404">404 Not Found</option>
                        <option value="500">500 Server Error</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" id="filterBtn">Apply Filters</button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-secondary w-100" id="resetBtn">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            Request/Response Logs
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="logsTable">
                    <thead>
                        <tr>
                            <th>Id</th>
                            <th>Time</th>
                            <th>Method</th>
                            <th>Path</th>
                            <th>Status</th>
                            <th>Duration</th>
                            <th>IP Address</th>
                            <th>User ID</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded via AJAX -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <nav aria-label="Page navigation" class="mt-3">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- Pagination will be generated via JS -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="logDetailsModal" tabindex="-1" aria-labelledby="logDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logDetailsModalLabel">Log Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Log ID:</strong> <span id="detailId"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Time:</strong> <span id="detailTime"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Method:</strong> <span id="detailMethod"></span>
                    </div>
                    <div class="col-md-6">
                         <strong>Status:</strong> <span id="detailStatus"></span>
                    </div>
                </div>
                 <div class="row mb-3">
                    <div class="col-12">
                        <strong>Path:</strong> <span id="detailPath"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                         <strong>Duration:</strong> <span id="detailDuration"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>User ID:</strong> <span id="detailUserId"></span>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>Request Body</h6>
                    <pre class="bg-light p-3 border rounded" id="detailRequestBody" style="max-height: 200px; overflow-y: auto;"></pre>
                </div>
                <div class="mb-3">
                    <h6>Response Body</h6>
                    <pre class="bg-light p-3 border rounded" id="detailResponseBody" style="max-height: 200px; overflow-y: auto;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            let currentPage = 1;
            const pageSize = 10;
            
            // Initial load
            loadLogs();
            
            // Filter button
            $('#filterBtn').click(function() {
                currentPage = 1;
                loadLogs();
            });
            
            // Reset button
            $('#resetBtn').click(function() {
                $('#searchInput').val('');
                $('#methodFilter').val('');
                $('#statusCodeFilter').val('');
                currentPage = 1;
                loadLogs();
            });
            
            function loadLogs() {
                const searchTerm = $('#searchInput').val();
                const method = $('#methodFilter').val();
                const statusCode = $('#statusCodeFilter').val();
                
                $.ajax({
                    url: '/Admin/Logs/GetAll',
                    type: 'GET',
                    data: {
                        PageNumber: currentPage,
                        PageSize: pageSize,
                        SearchTerm: searchTerm,
                        Method: method,
                        StatusCode: statusCode,
                        SortBy: 'CreatedAt',
                        SortOrder: 'desc'
                    },
                    success: function (response) {
                        if (response.success) {
                            renderTable(response.data.items);
                            renderPagination(response.data.totalCount, currentPage, pageSize);
                        } else {
                            alert('Error loading logs: ' + response.message);
                        }
                    },
                    error: function () {
                        alert('Error loading logs');
                    }
                });
            }
            
            function renderTable(logs) {
                const tbody = $('#logsTable tbody');
                tbody.empty();
                
                if (logs.length === 0) {
                    tbody.append('<tr><td colspan="9" class="text-center">No logs found</td></tr>');
                    return;
                }
                
                logs.forEach(function (log) {
                    const statusClass = getStatusClass(log.responseStatusCode);
                    const date = new Date(log.createdAt).toLocaleString();
                    
                    const row = `
                        <tr>
                            <td>${log.id}</td>
                            <td>${date}</td>
                            <td><span class="badge bg-secondary">${log.method}</span></td>
                            <td class="text-truncate" style="max-width: 200px;" title="${log.path}">${log.path}</td>
                            <td><span class="badge ${statusClass}">${log.responseStatusCode}</span></td>
                            <td>${log.durationMs} ms</td>
                            <td>${log.ipAddress || '-'}</td>
                            <td>${log.userId || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-info text-white view-details" data-id="${log.id}">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
                
                // Attach event listeners to new buttons
                $('.view-details').click(function() {
                    const id = $(this).data('id');
                    showDetails(id);
                });
            }
            
            function getStatusClass(statusCode) {
                if (statusCode >= 200 && statusCode < 300) return 'bg-success';
                if (statusCode >= 300 && statusCode < 400) return 'bg-info';
                if (statusCode >= 400 && statusCode < 500) return 'bg-warning text-dark';
                return 'bg-danger';
            }
            
            function renderPagination(totalCount, currentPage, pageSize) {
                const totalPages = Math.ceil(totalCount / pageSize);
                const pagination = $('#pagination');
                pagination.empty();
                
                // Previous
                pagination.append(`
                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
                    </li>
                `);
                
                // Pages logic (simplified)
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                        pagination.append(`
                            <li class="page-item ${i === currentPage ? 'active' : ''}">
                                <a class="page-link" href="#" data-page="${i}">${i}</a>
                            </li>
                        `);
                    } else if (i === currentPage - 3 || i === currentPage + 3) {
                         pagination.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
                    }
                }
                
                // Next
                pagination.append(`
                    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
                    </li>
                `);
                
                // Attach event listeners
                $('#pagination .page-link').click(function(e) {
                    e.preventDefault();
                    const page = $(this).data('page');
                    if (page && page !== currentPage) {
                        currentPage = page;
                        loadLogs();
                    }
                });
            }
            
            function showDetails(id) {
                $.ajax({
                    url: '/Admin/Logs/Details/' + id,
                    type: 'GET',
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                    success: function (response) {
                        if (response.success) {
                            const log = response.data;
                            
                            $('#detailId').text(log.id);
                            $('#detailTime').text(new Date(log.createdAt).toLocaleString());
                            $('#detailMethod').text(log.method);
                            $('#detailPath').text(log.path);
                            
                            const statusBadge = `<span class="badge ${getStatusClass(log.responseStatusCode)}">${log.responseStatusCode}</span>`;
                            $('#detailStatus').html(statusBadge);
                            
                            $('#detailDuration').text(log.durationMs + ' ms');
                            $('#detailUserId').text(log.userId || 'N/A');
                            
                            $('#detailRequestBody').text(log.requestBody || 'None');
                            $('#detailResponseBody').text(log.responseBody || 'None');
                            
                            const modal = new bootstrap.Modal(document.getElementById('logDetailsModal'));
                            modal.show();
                        } else {
                            alert('Error loading details');
                        }
                    },
                    error: function () {
                        alert('Error loading details');
                    }
                });
            }
        });
    </script>
}
